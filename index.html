<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekstraktor Data Timesheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">ðŸ“„ Ekstraktor Data Timesheet</h1>
                <p class="text-gray-600 mt-2">Unggah file PDF untuk menampilkan semua absensi (hanya status OFF yang akan ditampilkan).</p>
            </div>

            <!-- Upload Section -->
            <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-6 text-center mb-6">
                <input type="file" id="pdfFile" accept=".pdf" class="hidden">
                <button id="uploadButton" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                    Pilih File PDF
                </button>
                <p id="fileName" class="mt-4 text-gray-500 text-sm"></p>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-6">
                <button id="extractBtn" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-green-700 transition duration-300 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Mulai Ekstraksi
                </button>
                <button id="downloadBtn" class="w-full sm:w-auto bg-purple-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-purple-700 transition duration-300 shadow-md hidden">
                    Unduh XLSX
                </button>
            </div>
            
            <!-- Loader and Status -->
            <div id="status" class="text-center my-4 h-8"></div>
            <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto mb-4 hidden"></div>

            <!-- Results Container -->
            <div id="resultsContainer" class="space-y-8">
                <!-- Data yang dikelompokkan akan ditampilkan di sini -->
            </div>
             <div id="no-results" class="text-center text-gray-500 py-8 hidden">
                <p>Tidak ada data yang ditemukan pada file ini.</p>
            </div>
        </div>
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Dibuat dengan Gemini API</p>
        </footer>
    </div>

    <script>
        // Inisialisasi PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        // Elemen UI
        const pdfFileInput = document.getElementById('pdfFile');
        const uploadButton = document.getElementById('uploadButton');
        const extractBtn = document.getElementById('extractBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const fileNameDisplay = document.getElementById('fileName');
        const statusDisplay = document.getElementById('status');
        const loader = document.getElementById('loader');
        const resultsContainer = document.getElementById('resultsContainer');
        const noResultsMessage = document.getElementById('no-results');

        let pdfFile = null;
        let extractedData = [];

        // Event listener
        uploadButton.addEventListener('click', () => pdfFileInput.click());
        pdfFileInput.addEventListener('change', handleFileSelect);
        extractBtn.addEventListener('click', processPdf);
        downloadBtn.addEventListener('click', downloadXLSX);

        /**
         * Menangani pemilihan file PDF.
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                pdfFile = file;
                fileNameDisplay.textContent = `File terpilih: ${file.name}`;
                extractBtn.disabled = false;
                resetUI();
            } else {
                fileNameDisplay.textContent = 'Silakan pilih file dengan format PDF.';
                pdfFile = null;
                extractBtn.disabled = true;
            }
        }

        /**
         * Mereset tampilan UI ke kondisi awal.
         */
        function resetUI() {
            extractedData = [];
            resultsContainer.innerHTML = '';
            downloadBtn.classList.add('hidden');
            noResultsMessage.classList.add('hidden');
            statusDisplay.textContent = '';
        }

        /**
         * Memproses file PDF yang dipilih, mengekstrak data per halaman.
         */
        async function processPdf() {
            if (!pdfFile) {
                statusDisplay.textContent = 'Pilih file PDF terlebih dahulu.';
                return;
            }

            resetUI();
            setLoading(true, 'Membaca file PDF...');

            try {
                const fileReader = new FileReader();
                fileReader.onload = async function() {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        statusDisplay.textContent = `Memproses halaman ${i} dari ${pdf.numPages}...`;
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        
                        const base64Image = canvas.toDataURL('image/jpeg').split(',')[1];
                        await callGeminiAPI(base64Image);
                    }
                    displayData();
                    setLoading(false, 'Ekstraksi selesai!');
                };
                fileReader.readAsArrayBuffer(pdfFile);
            } catch (error) {
                console.error('Error saat memproses PDF:', error);
                setLoading(false, 'Terjadi kesalahan saat memproses PDF.');
            }
        }
        
        /**
         * Membersihkan dan menstandarkan nilai dari kolom tanda tangan.
         * @param {string} status - Teks asli dari kolom tanda tangan.
         * @returns {string} - Teks yang sudah distandarkan.
         */
        function normalizeTandaTangan(status) {
            const upperStatus = (status || '').toUpperCase();
            if (upperStatus.includes('FF')) {
                return 'OFF';
            }
            if (status === null || status.trim() === '' || status.trim() === '.') {
                return 'Hadir';
            }
            return status;
        }

        /**
         * Memanggil Gemini API untuk mengekstrak data dari gambar.
         */
        async function callGeminiAPI(base64ImageData) {
            const apiKey = "AIzaSyBvt7AwUfkdNGGW1jM1DCy85uJFKWmA180"; // Kunci API akan disediakan secara otomatis
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [
                        { text: "Ekstrak tanggal (dari 'Hari/Tanggal') dan semua data karyawan dari tabel pada gambar timesheet ini. Untuk setiap baris karyawan, berikan nama, jam masuk, jam keluar, dan isi dari kolom 'TANDA TANGAN'. Jika kolom tanda tangan kosong atau hanya berisi titik, anggap sebagai 'Hadir'." },
                        { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            tanggal: { type: "STRING" },
                            karyawan: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        nama: { type: "STRING" },
                                        jam_masuk: { type: "STRING" },
                                        jam_keluar: { type: "STRING" },
                                        tanda_tangan: { type: "STRING" }
                                    },
                                    required: ["nama", "jam_masuk", "jam_keluar", "tanda_tangan"]
                                }
                            }
                        },
                        required: ["tanggal", "karyawan"]
                    }
                }
            };

            let success = false;
            let retries = 3;
            let delay = 1000;

            while (retries > 0 && !success) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                        const parsedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                        if (parsedJson.tanggal && parsedJson.karyawan) {
                            parsedJson.karyawan.forEach(item => {
                                extractedData.push({
                                    tanggal: parsedJson.tanggal,
                                    nama: item.nama,
                                    jam_masuk: item.jam_masuk,
                                    jam_keluar: item.jam_keluar,
                                    tanda_tangan: normalizeTandaTangan(item.tanda_tangan)
                                });
                            });
                        }
                        success = true;
                    } else {
                       console.warn("Struktur respons tidak terduga:", result);
                    }
                } catch (error) {
                    console.error(`Attempt failed: ${error}. Retrying in ${delay / 1000}s...`);
                    retries--;
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        statusDisplay.textContent = 'Gagal menghubungi API setelah beberapa kali percobaan.';
                    }
                }
            }
        }

        /**
         * Menampilkan data yang telah diekstrak, dikelompokkan berdasarkan tanggal.
         */
        function displayData() {
            resultsContainer.innerHTML = '';
            if (extractedData.length > 0) {
                const groupedData = extractedData.reduce((acc, item) => {
                    const date = item.tanggal || 'Tanpa Tanggal';
                    if (!acc[date]) {
                        acc[date] = [];
                    }
                    acc[date].push(item);
                    return acc;
                }, {});

                for (const date in groupedData) {
                    const dateSection = document.createElement('div');
                    
                    const dateHeader = document.createElement('h3');
                    dateHeader.className = 'text-xl font-semibold text-gray-700 mb-3';
                    dateHeader.textContent = date;
                    dateSection.appendChild(dateHeader);

                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'overflow-x-auto';
                    
                    const table = document.createElement('table');
                    table.className = 'min-w-full bg-white rounded-lg shadow overflow-hidden';
                    
                    table.innerHTML = `
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="py-3 px-4 text-left">Nama</th>
                                <th class="py-3 px-4 text-left">Jam Masuk</th>
                                <th class="py-3 px-4 text-left">Jam Keluar</th>
                                <th class="py-3 px-4 text-left">Tanda Tangan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${groupedData[date].map(item => `
                                <tr class="border-b hover:bg-gray-100">
                                    <td class="py-3 px-4">${item.nama || '-'}</td>
                                    <td class="py-3 px-4">${item.jam_masuk || '-'}</td>
                                    <td class="py-3 px-4">${item.jam_keluar || '-'}</td>
                                    <td class="py-3 px-4">${formatTandaTangan(item.tanda_tangan)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    tableContainer.appendChild(table);
                    dateSection.appendChild(tableContainer);
                    resultsContainer.appendChild(dateSection);
                }
                
                downloadBtn.classList.remove('hidden');
                noResultsMessage.classList.add('hidden');
            } else {
                downloadBtn.classList.add('hidden');
                noResultsMessage.classList.remove('hidden');
            }
        }
        
        /**
         * Memberi format pada kolom tanda tangan untuk tampilan yang lebih baik.
         * Hanya menampilkan status 'OFF'.
         */
        function formatTandaTangan(status) {
            if (!status) return ''; // Kosongkan jika tidak ada status
            const upperStatus = status.toUpperCase();
            if (upperStatus === 'OFF') {
                return `<span class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${status}</span>`;
            }
            return ''; // Kosongkan untuk status lainnya
        }

        /**
         * Mengunduh data dalam format XLSX.
         */
        function downloadXLSX() {
            if (extractedData.length === 0) {
                statusDisplay.textContent = 'Tidak ada data untuk diunduh.';
                return;
            }
            const dataForExport = extractedData.map(item => ({
                Tanggal: item.tanggal,
                Nama: item.nama,
                "Jam Masuk": item.jam_masuk,
                "Jam Keluar": item.jam_keluar,
                // Logika filter untuk file Excel
                "Tanda Tangan": item.tanda_tangan.toUpperCase() === 'OFF' ? 'OFF' : ''
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataForExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data Absensi");
            XLSX.writeFile(workbook, "Data_Absensi_Karyawan_Filtered.xlsx");
        }

        /**
         * Mengatur status loading pada UI.
         */
        function setLoading(isLoading, message = '') {
            if (isLoading) {
                loader.classList.remove('hidden');
                extractBtn.disabled = true;
                uploadButton.disabled = true;
            } else {
                loader.classList.add('hidden');
                extractBtn.disabled = false;
                uploadButton.disabled = false;
            }
            statusDisplay.textContent = message;
        }
    </script>
</body>
</html>
